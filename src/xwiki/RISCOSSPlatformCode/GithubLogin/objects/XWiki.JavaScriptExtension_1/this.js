XWikiObj(function (obj) {
    obj.setCache("forbid");
    obj.setCode("require(['jquery'],function($){\n$(function(){\n\n//Initialize connect github button\n$('#connectGithub').click(function(event){\nevent.preventDefault();\n//PopUp mode\n//Initialize the public key (got from https://oauth.io/)\nOAuth.initialize(\"UI-dXouxI4J18UhIAXr-J0yK9H8\");\nvar provider = 'github';\nOAuth.popup(provider)\n.done(function(result) {\n     //After getting the authorization send a request to github to get information about the connected user\n     result.me()\n    .done(function (response) {\n        //Create the XWiki user if not exists\n        var saveURL = \"$xwiki.getURL('RISCOSSPlatformCode.GithubLogin','view','xpage=plain&outputSyntax=plain')\";\n        var data = response;\n        var fullName = response.name;\n        var firstName = \"\";\n        var lastName = \"\";\n        firstName = (fullName && fullName != \"\") ? fullName.split(\" \")[0] : fullName;\n        lastName = (fullName && fullName != \"\" && fullName.split(\" \").length == 2) ? fullName.split(\" \")[1] : fullName;\n        var password = Math.random().toString(36).slice(-8);\n        //Set xwiki register form parameters\n        data.register_first_name = firstName;\n        data.register_last_name = lastName;\n        data.xwikiname = response.alias;\n        data.register_password = password;\n        data.register2_password = password;\n        data.register_email = response.email;\n        var request = $.ajax({\n          url: saveURL,\n             method: \"POST\",\n             data: response,\n             dataType: \"json\"\n          });\n          request.done(function( msg ) {\n             if(msg.rep && msg.rep == 1){//Success\n               if(msg.loginURL){\n                  //Authentificate\n                  document.location.replace(msg.loginURL); \n               }\n             }\n             else\n             {\n                //Go to the main page\n                document.location.replace(\"$xwiki.getURL('Main.WebHome')\"); \n             }\n          });\n          request.fail(function( jqXHR, textStatus ) {\n            alert( \"Request failed: \" + textStatus );\n          });\n    })\n    .fail(function (err) {\n        //handle error with err\n    });\n})\n.fail(function (err) {\n    //handle error with err\n});\n});\n\n});\n});");
    obj.setName("Initialize OAuth");
    obj.setParse("1");
    obj.setUse("onDemand");
});
