XWikiObj(function (obj) {
    obj.setCache("forbid");
    obj.setCode("require(['jquery'],function($){\r\n$(function(){\r\n\r\n## Get RISCOSS platform configuration information\r\n#set($confDoc = $xwiki.getDocument(\"RISCOSSPlatformCode.RISCOSSConfiguration\"))\r\n#set($confObj = $confDoc.getObject(\"RISCOSSPlatformCode.RISCOSSConfiguration\"))\r\n#set($oauthPublicKey = $confObj.getProperty(\"oauthPublicKey\").getValue())\r\n#if(\"$!oauthPublicKey\" != \"\")\r\n//Initialize connect github button\r\n$('#connectGithub').click(function(event){\r\nevent.preventDefault();\r\n//PopUp mode\r\n//Initialize the public key (got from https://oauth.io/)\r\nOAuth.initialize(\"$oauthPublicKey\");\r\nvar provider = 'github';\r\nOAuth.popup(provider)\r\n.done(function(result) {\r\n     //After getting the authorization send a request to github to get information about the connected user\r\n     result.me()\r\n    .done(function (response) {\r\n        //Create the XWiki user if not exists\r\n        var saveURL = \"$xwiki.getURL('RISCOSSPlatformCode.GithubLogin','view','xpage=plain&outputSyntax=plain')\";\r\n        var data = response;\r\n        var fullName = response.name;\r\n        var firstName = \"\";\r\n        var lastName = \"\";\r\n        firstName = (fullName && fullName != \"\") ? fullName.split(\" \")[0] : fullName;\r\n        lastName = (fullName && fullName != \"\" && fullName.split(\" \").length == 2) ? fullName.split(\" \")[1] : fullName;\r\n        var password = Math.random().toString(36).slice(-8);\r\n        //Set xwiki register form parameters\r\n        data.register_first_name = firstName;\r\n        data.register_last_name = lastName;\r\n        data.xwikiname = response.alias;\r\n        data.register_password = password;\r\n        data.register2_password = password;\r\n        data.register_email = response.email;\r\n        var request = $.ajax({\r\n          url: saveURL,\r\n             method: \"POST\",\r\n             data: response,\r\n             dataType: \"json\"\r\n          });\r\n          request.done(function( msg ) {\r\n             if(msg.rep && msg.rep == 1){//Success\r\n               if(msg.loginURL){\r\n                  //Authentificate\r\n                  document.location.replace(msg.loginURL); \r\n               }\r\n             }\r\n             else\r\n             {\r\n                //Go to the main page\r\n                document.location.replace(\"$xwiki.getURL('Main.WebHome')\"); \r\n             }\r\n          });\r\n          request.fail(function( jqXHR, textStatus ) {\r\n            alert( \"Request failed: \" + textStatus );\r\n          });\r\n    })\r\n    .fail(function (err) {\r\n        //handle error with err\r\n    });\r\n})\r\n.fail(function (err) {\r\n    //handle error with err\r\n});\r\n});\r\n#end\r\n});\r\n});");
    obj.setName("Initialize OAuth");
    obj.setParse("1");
    obj.setUse("onDemand");
});
